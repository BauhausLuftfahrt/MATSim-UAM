var crosscompare={height:200,width:"auto",padding:{top:20,right:5,bottom:10,left:25},anchor:"#crosscompare",dateFormat:"%d/%m/%Y",xGrid:!1,yGrid:!1,flash:!0,legends:[],overwrite:!1,chart:{},charts:{},queue:[]};crosscompare.setHeight=function(e){return e>=0&&(this.height=e),this},crosscompare.setWidth=function(e){return(e>=0||"auto"==e)&&(this.width=e),this},crosscompare.setPadding=function(e,t,r,o){return"number"==typeof e&&"number"==typeof t&&"number"==typeof r&&"number"==typeof o&&(this.padding={top:e,right:t,bottom:r,left:o}),this},crosscompare.setAnchor=function(e){return"undefined"!=typeof e&&e.length>0&&(this.anchor=e),this},crosscompare.setDateFormat=function(e){return"undefined"!=typeof e&&e.length>0&&(this.dateFormat=e),this},crosscompare.setGrid=function(e,t){return"boolean"==typeof e&&"boolean"==typeof t&&(this.xGrid=e,this.yGrid=t),this},crosscompare.setFlash=function(e){return"boolean"==typeof e&&(this.flash=e),this},crosscompare.addLegend=function(e,t){return"undefined"!=typeof e&&this.legends.push({legend:e,title:t?t:""}),this},crosscompare.setOverwrite=function(e){return"boolean"==typeof e&&(this.overwrite=e),this},crosscompare.add=function(e,t){var r={chart:e,type:"line",ratio:.5,value:"default",anchor:e.anchor()+"-cross",order:"default",yLabel:"",xLabel:""};"undefined"!=typeof t&&$.each(t,function(e,t){r[e]=t});var o=r.anchor;return this.charts[o]=r,$(o).on("click",function(){crosscompare.flash&&$(e.anchor()).fadeTo(10,.3).fadeTo(700,1);var t="You have cached ";$.isEmptyObject(crosscompare.chart)?t+="1 state.":crosscompare.chart.source==e?t+=crosscompare.queue.length+1+" states.":(crosscompare.clear(),t="Overwritten with new state."),$(crosscompare.anchor+"-info").text(t),crosscompare.chart.source=e,crosscompare.cache(o)}),this},crosscompare.cache=function(e){var t="";0==this.legends.length?t+=this.queue.length+1:($.each(this.legends,function(e,r){if("string"==typeof r.legend)""!=r.title&&(t+=r.title+":"),t+=$(r.legend).val()+" ";else{var o=r.legend.filters(),s=d3.time.format(crosscompare.dateFormat);"undefined"!=typeof o&&o.length>0&&(""!=r.title&&(t+=r.title+":"),t+=o[0].constructor===Array?o[0][0]instanceof Date?s(o[0][0])+" - "+s(o[0][1])+" ":o[0][0]+" - "+o[0][1]:o+" ")}}),""==t&&(t="ALL "),this.overwrite||$.each(crosscompare.queue,function(e,r){r.id==t&&(t+="("+(crosscompare.queue.length+1)+")")}));for(var r=this.charts[e].chart,o=this.charts[e].value,s=$.extend(!0,[],r.group().all()),a=r.filters(),c=s.length;c--;){if("default"!=o&&(s[c].value=s[c].value[o]),"undefined"!=typeof a&&a.length>0)if(a[0].constructor===Array)(s[c].key<a[0][0]||s[c].key>a[0][1])&&(s[c].value=null);else if(-1==a.indexOf(s[c].key)){s.splice(c,1);continue}s[c][t]=s[c].value,delete s[c].value}this.queue.push({anchor:e,id:t,data:s})},crosscompare.reset=function(){var e=crosscompare.chart.rendered;"undefined"!=typeof e&&e.destroy(),crosscompare.clear()},crosscompare.clear=function(){$(crosscompare.anchor+"-info").text("Cache cleared."),this.chart={},this.queue=[]},crosscompare.render=function(){function e(e,t,r){e=e.sort(function(e,o){return r?e[t]>o[t]?1:e[t]<o[t]?-1:0:o[t]>e[t]?1:o[t]<e[t]?-1:0})}if(this.queue.length>0){$(crosscompare.anchor+"-info").text("Comparison rendered.");var t,r,o=this.queue[0].anchor,s=this.charts[o].type,a=this.charts[o].order,c=this.charts[o].yLabel,n=this.charts[o].xLabel,h=this.queue[0].data[0].key,d=h instanceof Date,u=!isNaN(parseFloat(h))&&isFinite(h),l=[],p=[];$.each(crosscompare.queue,function(e,o){var s,a,c=o.data;if(d||u){for(i=0;i<c.length;i++)if(null!=c[i][o.id]){s=c[i].key;break}for(i=c.length-1;i>=0;i--)if(null!=c[i][o.id]){a=c[i].key;break}0!=e&&(s=Math.min(s,t),a=Math.max(a,r)),t=s,r=a}$.extend(!0,l,c),p.push(o.id)});var f=this.queue[0].id;"default"!=a&&("asc"==a?e(l,f,!0):e(l,f,!1));var m={bindto:crosscompare.anchor,size:{height:crosscompare.height},padding:crosscompare.padding,data:{json:l,keys:{x:"key",value:p}},zoom:{enabled:!0,rescale:!0},color:{pattern:d3.scale.category10().range()}};0==crosscompare.legends.length&&(m.legend={show:!1}),"auto"!=crosscompare.width&&(m.size.width=crosscompare.width),d||u?(m.axis={x:{tick:{fit:!1},min:Number(t),max:Number(r)}},d&&(m.axis.x.type="timeseries",m.axis.x.tick.format=crosscompare.dateFormat)):m.axis={x:{type:"category"}},"line"!=s&&(m.data.type=s),"bar"==s&&(m.bar={width:{ratio:this.charts[o].ratio}}),m.grid={x:{show:crosscompare.xGrid},y:{show:crosscompare.yGrid}},""!=c&&(m.axis.y={label:c}),""!=n&&(m.axis.x.label=n),crosscompare.chart.rendered=c3.generate(m)}else $(crosscompare.anchor+"-info").text("Nothing cached.")},"undefined"!=typeof exports&&(module.exports=crosscompare);